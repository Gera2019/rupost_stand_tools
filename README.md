# rupost_stand_tools
Набор скриптов для быстрого разворачивания тестового стэнда почтовой системы Rupost, по-умочанию с 2мя узлами
***
Набор скриптов:
- make-cluster.sh (main script)
- add-node.sh
- add-general-node.sh
- clone-group.sh
- rm-grp.sh
- clean-db.sh
- update-nfs.sh
- get-haproxy-conf.py
- install-rupost.sh

***
##### Предваительные требования к системе, на которой планируется развернуть тестовый стэнд
- Astra Linux 1.7 и выше 

***
Основной скрипт *make_cluster.sh* запущенный без каких-либо параметров: 
- развернёт систему контейнеров LXC,
- настроит сетевые интерфейсы для форвардинга пакетов, определит сетевые настройки контейнеров
- создаст необходимые записи ДНС сервиса для успешной работы почтовой системы
- создаст контейнеры-исходники, на основе которых будут создаватся необходимые узлы тестового стенда
- создаст группу, которая будет состоять из контейнера с БД Postgres и 2 узлами для сервера RuPost
- создаст конфигурацию для балансировщика, который будет распределять трафик между узлами RuPost

*make_cluster.sh*
```
bash make-cluster.sh --help
usage: make-cluster.sh [-n|--nodes NUM][-i|--init][--h|--help]
    -n|--nodes NUM количество узлов; если параметр не указан, то NUM=2.
    -i|--init [NUM] инициируется развертывание новой группы
```
В случае использования опции -i, то будет создана новая группа. Если цифровое значение не указано, то будет создана следуюзая по возрастанию группа.

также настраивается простой балансир HaProxy и DNS и NFS сервера

- внутренняя сеть кластера 10.20.30.0/24 - опцию развертывания с сетью хоста не выбирать, пока не работает (зам. ГА)
- Доступно 2 почтовых домена **rupost.local**, **am.local** и **workspad.local** для всех доменов MX = **mail.rupost.local** - в файле ldap-domains можно определить свои домены (зам. ГА)
- IP для настройки **NFS** и MemCache **10.20.30.1** порты и пути по умолчанию
- пароль на вход ssh на все контейнеры user: **admin** passw: **astralinux**
***

#### Настройка виртуальной машины

На виртуальную машину (min 4Gib RAM), 4 CPU, 32Gib HDD) установим Astra Linux SE 1.7.3
после установки скопируем на нее дистрибутив РуПоста и скрипты установки [make-cluster.sh](https://emw.workspad.com/user/WebClient/filemanager/file-download?root=117&path=%2FContainers%2FLXC%2FAuto%20make%20cluster%2Fmake-cluster.sh) [install-rupost.sh](https://emw.workspad.com/user/WebClient/filemanager/file-download?root=117&path=%2FContainers%2FLXC%2FAuto%20make%20cluster%2Finstall-rupost.sh) [add-node.sh](https://emw.workspad.com/user/WebClient/filemanager/file-download?root=117&path=%2FContainers%2FLXC%2FAuto%20make%20cluster%2Fadd-node.sh)
(установочный файл сервера RuPost разместить в директории **src/**, для возможности автоматической установки сервера в подготовленные контейнеры (зам. ГА)

развернуть кластер
```bash
sudo bash make-cluster.sh
```

> примерное время выполнение скрипта 10-15 минут (это нужно только первый раз)
> большая часть времени уходит на сборку базового контейнера из которого собираются оставшиеся
> по завершению этаго скрипта можно сделать снапшот всей виртуалки или для нод средствами lxc и более не тратить время на сборку просто возвращаясь к этому этапу при тестировании дугой версии RuPost

Действия по отдельной установке не требуются, если была выбрана автоматическая установка сервера в контейнеры (зам. ГА)
для установки на ноду РуПоста, предварительно необходим дистрибутив на хосте(виртуалке)
установка в silent "тихом" режиме,без использования графического конфигуратора
```bash
sudo bash install-rupost.sh -n 1 -d rupost-1.1.0-alse-amd64.deb
```
где -n 1 - номер ноды
-d rupost-1.1.0-alse-amd64.deb - путь до дистрибутива
также потдерживается установка с новым визардом.
```bash
sudo bash install-rupost.sh -n 1 -d rupost-1.1.0-alse-amd64.run
```

**Добавить ноду в кластер (добавление без установки РуПоста)**

```bash
sudo bash add-node.sh
```
скрипт добавит контейнер для установки РуПоста. Возможно создать не более 5  контейнеров.
```bash
sudo bash add-node.sh 3
```
При использовании команды с числом в качестве параметра, скрипт очистит контейнер и подготовит его под установку

**Посмотреть состояние нод и их имена и ip адреса**
```bash
sudo lxc-ls -f
```

**быстро зайти на ноду по ssh без ввода пароля :-)**
```bash
sshpass -p 'astralinux' ssh -o StrictHostKeyChecking=no -l admin node-rupost1
```

**или средствами lxc**
```bash
sudo lxc-attach node-rupost1
```

Для контроля состояния узлов доступна страница статистики по локальному адресу или адресу хоста
```
http://mail.rupost.local:8888/stats user/passw : rupost/rupost
```

### Для доступа к кластеру из другой виртуальной машины

необходимо чтобы они были в одной сети или была правильно настроена маршрутизация между ними.
На второй ВМ добавить маршрут (роутинг) на сеть 10.20.30.0/24 через IP ВМ с кластера
и в качестве DNS сервера указать 10.20.30.1
 
*Windows(с правами локального администратора)*
```
route add 10.20.30.0 mask 255.255.255.0 IP(вм кластера)
```

Linux(debian)
```bash
sudo ip route add 10.20.30.0/24 via IP(вм кластера)
```

После перезагрузки все маршруты, добавленные таким способом, исчезнут. Чтобы статический маршрут сохранялся после перезагрузки:

*Windows(использовать ключ -p)*
```
route -p add 10.20.30.0 mask 255.255.255.0 IP(вм кластера)
```

Linux(редактируем interfaces, добавляя в описание интерфейса)
```
post-up route add -net 10.20.30.0 netmask 255.255.255.0 gw IP(вм кластера)
pre-down route del -net 10.20.30.0 netmask 255.255.255.0 gw IP(вм кластера)
```

**Примечание**: если что-то пошло не так на этапе "make-cluster.sh" (как обычно отвалился download.astralinux.ru) надо удалить все созданные конейнеры
посмотреть список контейнеров: 
```
sudo lxc-ls -f  
```
удалить конкретный контейнер: 
```
sudo lxc-destroy node-clean node-rupost1
```
и запустить скрипт снова
